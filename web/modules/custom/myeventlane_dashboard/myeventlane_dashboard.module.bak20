<?php

/**
 * @file
 * Primary module hooks for MyEventLane Dashboard module.
 */

declare(strict_types=1);

/**
 * Implements hook_theme().
 */
function myeventlane_dashboard_theme(): array {
  return [
    'myeventlane_dashboard' => [
      'variables' => [
        'is_admin' => FALSE,
        'is_admin_viewing_as_vendor' => FALSE,
        'vendor_store_id' => NULL,
        'event_count' => 0,
        'recent_events' => [],
      ],
      'template' => 'myeventlane-vendor-dashboard',
    ],
    'myeventlane_admin_dashboard' => [
      'variables' => [
        'is_admin' => TRUE,
        'is_admin_viewing_as_vendor' => FALSE,
        'event_count' => 0,
        'vendor_count' => 0,
        'user_count' => 0,
      ],
      'template' => 'myeventlane-admin-dashboard',
    ],
    'myeventlane_vendor_dashboard' => [
      'variables' => [
        'is_admin' => FALSE,
        'vendor_store_id' => NULL,
        'event_count' => 0,
        'recent_events' => [],
      ],
      'template' => 'myeventlane-vendor-dashboard',
    ],
    'dashboard_card' => [
      'variables' => [
        'title' => NULL,
        'value' => NULL,
        'description' => NULL,
        'link_url' => NULL,
        'link_text' => NULL,
        'icon' => NULL,
      ],
      'template' => 'dashboard-card',
    ],
    'myeventlane_customer_dashboard' => [
      'variables' => [
        'upcoming_events' => [],
        'past_events' => [],
        'welcome_message' => NULL,
      ],
      'template' => 'myeventlane-customer-dashboard',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function myeventlane_dashboard_theme_suggestions_myeventlane_dashboard(array $variables): array {
  $suggestions = [];

  if (!empty($variables['is_admin'])) {
    $suggestions[] = 'myeventlane_dashboard__admin';
    $suggestions[] = 'myeventlane_admin_dashboard';
  }
  else {
    $suggestions[] = 'myeventlane_dashboard__vendor';
    $suggestions[] = 'myeventlane_vendor_dashboard';
  }

  return $suggestions;
}

/**
 * Implements hook_preprocess_HOOK() for myeventlane_dashboard.
 */
function myeventlane_dashboard_preprocess_myeventlane_dashboard(array &$variables): void {
  _myeventlane_dashboard_add_stats($variables);
}

/**
 * Implements hook_preprocess_HOOK() for myeventlane_admin_dashboard.
 */
function myeventlane_dashboard_preprocess_myeventlane_admin_dashboard(array &$variables): void {
  _myeventlane_dashboard_add_stats($variables, TRUE);
}

/**
 * Implements hook_preprocess_HOOK() for myeventlane_vendor_dashboard.
 */
function myeventlane_dashboard_preprocess_myeventlane_vendor_dashboard(array &$variables): void {
  _myeventlane_dashboard_add_stats($variables);
}

/**
 * Adds dashboard statistics to template variables.
 *
 * @param array $variables
 *   The template variables.
 * @param bool $is_admin
 *   Whether this is the admin dashboard.
 */
function _myeventlane_dashboard_add_stats(array &$variables, bool $is_admin = FALSE): void {
  try {
    $entity_type_manager = \Drupal::entityTypeManager();

    // Event count.
    $query = $entity_type_manager
      ->getStorage('node')
      ->getQuery()
      ->accessCheck(TRUE)
      ->condition('type', 'event')
      ->condition('status', 1);

    $variables['event_count'] = (int) $query->count()->execute();

    if ($is_admin) {
      // Vendor count.
      if ($entity_type_manager->hasDefinition('myeventlane_vendor')) {
        $vendor_count = $entity_type_manager
          ->getStorage('myeventlane_vendor')
          ->getQuery()
          ->accessCheck(FALSE)
          ->count()
          ->execute();
        $variables['vendor_count'] = (int) $vendor_count;
      }

      // User count.
      $user_count = $entity_type_manager
        ->getStorage('user')
        ->getQuery()
        ->accessCheck(FALSE)
        ->condition('status', 1)
        ->condition('uid', 0, '>')
        ->count()
        ->execute();
      $variables['user_count'] = (int) $user_count;
    }
  }
  catch (\Exception $e) {
    $variables['event_count'] = 0;
  }
}
