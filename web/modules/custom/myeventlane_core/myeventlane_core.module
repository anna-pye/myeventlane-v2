<?php

/**
 * @file
 * Core services and utilities for MyEventLane platform.
 *
 * This module provides shared services used throughout MyEventLane:
 * - myeventlane_core.date_formatter: Date formatting utilities for events.
 * - myeventlane_core.route_helper: Route lookup and URL generation helpers.
 */

declare(strict_types=1);

/**
 * Implements hook_theme().
 */
function myeventlane_core_theme(): array {
  return [
    'myeventlane_my_categories' => [
      'variables' => [
        'followed_categories' => [],
      ],
      'template' => 'myeventlane-my-categories',
    ],
    'myeventlane_category_digest_email' => [
      'variables' => [
        'user' => NULL,
        'events_by_category' => [],
      ],
      'template' => 'myeventlane-category-digest-email',
    ],
    'customer_onboard_step' => [
      'variables' => [
        'step_number' => 1,
        'total_steps' => 4,
        'step_title' => NULL,
        'step_description' => NULL,
        'content' => NULL,
      ],
      'template' => 'customer-onboard-step',
    ],
  ];
}

/**
 * Implements hook_mail().
 */
function myeventlane_core_mail($key, &$message, $params): void {
  $renderer = \Drupal::service('renderer');

  switch ($key) {
    case 'category_digest':
      $message['subject'] = $params['subject'] ?? t('Weekly Event Digest - New events in your categories');
      $message['body'][] = $params['body'] ?? '';
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
      break;
  }
}

/**
 * Implements hook_cron().
 */
function myeventlane_core_cron(): void {
  // Send weekly category digests on Sundays.
  $dayOfWeek = (int) date('w'); // 0 = Sunday
  if ($dayOfWeek !== 0) {
    return;
  }

  $digestGenerator = \Drupal::service('myeventlane_core.category_digest_generator');
  $userIds = $digestGenerator->getUsersWithFollowedCategories();

  if (empty($userIds)) {
    return;
  }

  $queue = \Drupal::service('queue')->get('mel_category_digest');
  foreach ($userIds as $userId) {
    $queue->createItem(['user_id' => $userId]);
  }
}
