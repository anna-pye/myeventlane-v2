<?php

namespace Drupal\myeventlane_checkout\Plugin\Commerce\CheckoutPane;

use Drupal\commerce_checkout\Plugin\Commerce\CheckoutPane\CheckoutPaneBase;
use Drupal\Core\Form\FormStateInterface;
use Drupal\paragraphs\Entity\Paragraph;
use Drupal\Core\Cache\CacheableMetadata;

/**
 * Provides a Ticket Holder Details pane.
 *
 * @CommerceCheckoutPane(
 *   id = "ticket_holder_pane",
 *   label = @Translation("Ticket Holder Info"),
 *   default_step = "order_information",
 *   wrapper_element = "fieldset",
 * )
 */
final class TicketHolderPane extends CheckoutPaneBase {

  /**
   * {@inheritdoc}
   */
  public function buildPaneForm(array $pane_form, FormStateInterface $form_state, array &$complete_form): array {
    $order = $this->order;

    $pane_form['order_items'] = [
      '#type' => 'container',
      '#attributes' => ['class' => ['ticket-holder-wrapper']],
    ];

    foreach ($order->getItems() as $index => $order_item) {
      $quantity = (int) $order_item->getQuantity();
      $data = $order_item->getData('ticket_holders') ?? [];

      $pane_form['order_items'][$index] = [
        '#type' => 'fieldset',
        '#title' => $this->t('Ticket Holders for: @title', ['@title' => $order_item->label()]),
        '#tree' => TRUE,
      ];

      for ($i = 0; $i < $quantity; $i++) {
        $paragraph = NULL;

        if (!empty($data[$i]['paragraph_id']) && $loaded = Paragraph::load($data[$i]['paragraph_id'])) {
          $paragraph = $loaded;
        }
        else {
          $paragraph = Paragraph::create(['type' => 'attendee_info']);
          $paragraph->save();
          $data[$i]['paragraph_id'] = $paragraph->id();
          $order_item->setData('ticket_holders', $data);
        }

        $pane_form['order_items'][$index][$i] = [
          '#type' => 'entity_inline_form',
          '#entity_type' => 'paragraph',
          '#bundle' => 'attendee_info',
          '#entity' => $paragraph,
          '#required' => TRUE,
        ];
      }
    }
      $cache = new CacheableMetadata();
      $cache->setCacheTags($node->getCacheTags());
      $cache->setCacheContexts(['user', 'user.permissions']);
      $cache->setCacheMaxAge(0);
      $cache->applyTo($pane_form); // ✅ writes #cache[max_age|contexts|tags]
    
   
    return $pane_form;
  }

  /**
   * {@inheritdoc}
   */
  public function validatePaneForm(array &$pane_form, FormStateInterface $form_state, array &$complete_form): void {
    \Drupal::logger('ticket_holder_pane')->notice('Running method X');
    $values = $form_state->getValue('order_items');

    // ✅ Prevent errors if pane is not shown or empty
    if (!is_array($values)) {
      \Drupal::logger('myeventlane')->notice('Skipping validation: no order_items submitted.');
      return;
    }

    foreach ($values as $index => $tickets) {
      if (!is_array($tickets)) {
        continue;
      }

      foreach ($tickets as $delta => $entry) {
        if (empty($entry['field_email'][0]['value'])) {
          $form_state->setErrorByName("order_items][$index][$delta][field_email", $this->t('Email is required.'));
        }
        if (empty($entry['field_first_name'][0]['value'])) {
          $form_state->setErrorByName("order_items][$index][$delta][field_first_name", $this->t('First name is required.'));
        }
        if (empty($entry['field_last_name'][0]['value'])) {
          $form_state->setErrorByName("order_items][$index][$delta][field_last_name", $this->t('Last name is required.'));
        }
      }
    }
  }

  /**
   * {@inheritdoc}
   */
    public function submitPaneForm(array &$pane_form, FormStateInterface $form_state, array &$complete_form): void {
      \Drupal::logger('ticket_holder_pane')->notice('Running method X');
      \Drupal::logger('debug')->notice('Submit fired!');
    $values = $form_state->getValue('order_items');

    // ✅ Prevent processing when nothing was submitted (pane was skipped)
    if (!is_array($values)) {
      \Drupal::logger('myeventlane')->notice('Skipping submission: no order_items submitted.');
      return;
    }

    foreach ($this->order->getItems() as $index => $order_item) {
      if (!isset($values[$index]) || !is_array($values[$index])) {
        continue;
      }

      $ticket_holder_data = [];
      foreach ($values[$index] as $delta => $entry) {
        $paragraph = $pane_form['order_items'][$index][$delta]['#entity'] ?? NULL;
        if ($paragraph && $paragraph->isNew()) {
          $paragraph->save();
        }
        $ticket_holder_data[] = ['paragraph_id' => $paragraph?->id()];
      }

      $order_item->setData('ticket_holders', $ticket_holder_data);
    }
  }

}