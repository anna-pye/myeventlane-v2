<?php

declare(strict_types=1);

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\NodeInterface;
use Drupal\taxonomy\TermInterface;

/**
 * Implements hook_form_alter().
 */
function myeventlane_event_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  // Ticket type paragraph conditional logic.
  \Drupal\myeventlane_event\Form\TicketTypeFormAlter::alterForm($form, $form_state);
}

/**
 * Implements hook_form_node_event_form_alter().
 *
 * This specific hook runs AFTER hook_form_alter, ensuring we can remove
 * conflicting elements added by other modules (like vendor module's tabs).
 */
function myeventlane_event_form_node_event_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  /** @var \Drupal\myeventlane_event\Form\EventFormAlter $alter */
  $alter = \Drupal::service('myeventlane_event.event_form_alter');
  $alter->alterForm($form, $form_state, $form_id);
}

/**
 * Implements hook_preprocess_node().
 */
function myeventlane_event_preprocess_node(array &$variables): void {
  if (empty($variables['node']) || !$variables['node'] instanceof NodeInterface) {
    return;
  }

  $node = $variables['node'];
  if ($node->bundle() !== 'event') {
    return;
  }

  // Defaults.
  $lat = NULL;
  $lng = NULL;

  // Pull coords if present.
  if ($node->hasField('field_event_lat') && !$node->get('field_event_lat')->isEmpty()) {
    $lat = (float) $node->get('field_event_lat')->value;
  }
  if ($node->hasField('field_event_lng') && !$node->get('field_event_lng')->isEmpty()) {
    $lng = (float) $node->get('field_event_lng')->value;
  }

  // Expose coords to Twig if needed.
  $variables['mel_event_lat'] = $lat;
  $variables['mel_event_lng'] = $lng;

  // Categories metadata for theming (name + color).
  $categories = [];
  if ($node->hasField('field_event_categories') && !$node->get('field_event_categories')->isEmpty()) {
    foreach ($node->get('field_event_categories')->referencedEntities() as $term) {
      if ($term instanceof TermInterface) {
        $color = NULL;
        if ($term->hasField('field_term_color') && !$term->get('field_term_color')->isEmpty()) {
          $color = $term->get('field_term_color')->value;
        }
        $categories[] = [
          'name' => $term->label(),
          'color' => $color,
        ];
      }
    }
  }
  $variables['mel_categories'] = $categories;

  // Attach the map library if coords exist.
  if ($lat !== NULL && $lng !== NULL) {
    $variables['#attached']['library'][] = 'myeventlane_location/event_map';
  }
}
