<?php

/**
 * @file
 * Module file for MyEventLane Donations.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function myeventlane_donations_theme(array $existing, string $type, string $theme, string $path): array {
  return [
    'myeventlane_donation_platform' => [
      'variables' => [
        'form' => NULL,
      ],
      'template' => 'myeventlane-donation-platform',
    ],
    'myeventlane_donation_report' => [
      'variables' => [
        'platform_stats' => [],
        'rsvp_stats' => [],
        'total_platform' => 0,
        'total_rsvp' => 0,
        'count_platform' => 0,
        'count_rsvp' => 0,
        'export_url' => '',
      ],
      'template' => 'myeventlane-donation-report',
    ],
    'myeventlane_donation_vendor_list' => [
      'variables' => [
        'events' => [],
        'total_donations' => 0,
        'total_count' => 0,
        'average_donation' => 0,
      ],
      'template' => 'myeventlane-donation-vendor-list',
    ],
  ];
}

/**
 * Implements hook_entity_access().
 *
 * Allows anonymous users to access their own draft orders (carts) during checkout.
 * This is necessary for RSVP donations where anonymous users need to complete checkout.
 */
function myeventlane_donations_entity_access(EntityInterface $entity, $operation, AccountInterface $account) {
  // Only process commerce_order entities.
  if ($entity->getEntityTypeId() !== 'commerce_order') {
    return AccessResult::neutral();
  }

  // Only allow 'view' and 'update' operations for draft orders.
  if (!in_array($operation, ['view', 'update'], TRUE)) {
    return AccessResult::neutral();
  }

  /** @var \Drupal\commerce_order\Entity\OrderInterface $order */
  $order = $entity;

  // Allow access if:
  // 1. Order is in draft state (cart)
  // 2. User is anonymous (UID 0) and order belongs to anonymous (UID 0)
  // 3. OR user owns the order
  if ($order->getState()->getId() === 'draft') {
    $orderUid = (int) $order->getCustomerId();
    $accountUid = (int) $account->id();

    // Anonymous users can access anonymous draft orders.
    if ($accountUid === 0 && $orderUid === 0) {
      return AccessResult::allowed()
        ->cachePerUser()
        ->addCacheableDependency($order);
    }

    // Authenticated users can access their own draft orders.
    if ($accountUid > 0 && $orderUid === $accountUid) {
      return AccessResult::allowed()
        ->cachePerUser()
        ->addCacheableDependency($order);
    }
  }

  // For non-draft orders, let Commerce handle access normally.
  return AccessResult::neutral();
}

