<?php

namespace Drupal\myeventlane_checkout_paragraph\Form;

use Drupal\Core\Form\FormBase;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityTypeManagerInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;
use Symfony\Component\HttpFoundation\RequestStack;
use Drupal\myeventlane_checkout_paragraph\Entity\TicketHolderInfo;

class TicketHolderForm extends FormBase {

  protected $entityTypeManager;
  protected $requestStack;

  public function __construct(EntityTypeManagerInterface $entityTypeManager, RequestStack $requestStack) {
    $this->entityTypeManager = $entityTypeManager;
    $this->requestStack = $requestStack;
  }

  public static function create(ContainerInterface $container) {
    return new static(
      $container->get('entity_type.manager'),
      $container->get('request_stack')
    );
  }

  public function getFormId() {
    return 'ticket_holder_form';
  }

  public function buildForm(array $form, FormStateInterface $form_state, $order = NULL, $variation = NULL, $quantity = 1) {
    $form['#tree'] = TRUE;
    $form['order'] = ['#type' => 'value', '#value' => $order->id()];
    $form['variation'] = ['#type' => 'value', '#value' => $variation->id()];

    // Load the Event from the Variation
    $event = $variation->get('field_event')->entity ?? NULL;
    $paragraphs = $event ? $event->get('field_attendee_questions')->referencedEntities() : [];

    for ($i = 0; $i < $quantity; $i++) {
      $form['tickets'][$i]['first_name'] = [
        '#type' => 'textfield',
        '#title' => $this->t('First name'),
        '#required' => TRUE,
      ];
      $form['tickets'][$i]['last_name'] = [
        '#type' => 'textfield',
        '#title' => $this->t('Last name'),
        '#required' => TRUE,
      ];
      $form['tickets'][$i]['email'] = [
        '#type' => 'email',
        '#title' => $this->t('Email'),
        '#required' => TRUE,
      ];

      // Render paragraph-based extra fields
      foreach ($paragraphs as $para) {
        $label = $para->get('field_field_label')->value ?? '';
        $type = $para->get('field_field_type')->value ?? 'text';
        \Drupal::messenger()->addMessage("Rendering extra field: " . $para->get('field_field_label')->value);
        $options_raw = $para->get('field_options')->value ?? '';
        $required = (bool) $para->get('field_required')->value;
        $options = array_filter(array_map('trim', explode("\n", $options_raw)));

        $field_id = 'extra_' . $para->id(); // e.g., extra_22

        $field = [
          '#title' => $label,
          '#required' => $required,
        ];

        switch ($type) {
          case 'text':
            $field['#type'] = 'textfield';
            break;
          case 'textarea':
            $field['#type'] = 'textarea';
            break;
          case 'select':
            $field['#type'] = 'select';
            $field['#options'] = array_combine($options, $options);
            break;
          case 'checkboxes':
            $field['#type'] = 'checkboxes';
            $field['#options'] = array_combine($options, $options);
            break;
          case 'radios':
            $field['#type'] = 'radios';
            $field['#options'] = array_combine($options, $options);
            break;
          default:
            $field['#type'] = 'textfield';
        }

        $form['tickets'][$i][$field_id] = $field;
      }
    }

    $form['actions']['submit'] = [
      '#type' => 'submit',
      '#value' => $this->t('Save ticket holders'),
    ];

    // Load the Event from the Variation
    $event = $variation->get('field_event')->entity ?? NULL;

    if (!$event) {
      \Drupal::messenger()->addError("No event loaded from variation.");
    }
    else {
      \Drupal::messenger()->addMessage("Loaded event: " . $event->label());
    }

    $paragraphs = $event ? $event->get('field_attendee_questions')->referencedEntities() : [];

    \Drupal::messenger()->addMessage("Found " . count($paragraphs) . " attendee question paragraphs.");

    return $form;
  }

  public function submitForm(array &$form, FormStateInterface $form_state) {
    $order_id = $form_state->getValue('order');
    $variation_id = $form_state->getValue('variation');
    $tickets = $form_state->getValue('tickets');

    $order = $this->entityTypeManager->getStorage('commerce_order')->load($order_id);
    $variation = $this->entityTypeManager->getStorage('commerce_product_variation')->load($variation_id);
    $event = $variation->get('field_event')->entity ?? NULL;

    foreach ($tickets as $ticket_data) {
      $ticket_holder = TicketHolderInfo::create([
        'type' => 'ticket_holder_info',
        'order_id' => $order_id,
        'event_id' => $event ? $event->id() : NULL,
        'ticket_type' => $variation_id,
        'first_name' => $ticket_data['first_name'],
        'last_name' => $ticket_data['last_name'],
        'email' => $ticket_data['email'],
        'uid' => \Drupal::currentUser()->id(),
      ]);

      // TODO: Save extra paragraph fields here, optionally to a child paragraph or JSON blob

      $ticket_holder->save();
    }



    \Drupal::messenger()->addMessage($this->t('Ticket holder details saved.'));
  }
}