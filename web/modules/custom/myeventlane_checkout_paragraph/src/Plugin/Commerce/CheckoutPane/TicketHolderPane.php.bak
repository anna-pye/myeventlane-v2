<?php

namespace Drupal\myeventlane_checkout_paragraph\Plugin\Commerce\CheckoutPane;

use Drupal\commerce_checkout\Plugin\Commerce\CheckoutPane\CheckoutPaneBase;
use Drupal\commerce_checkout\Plugin\Commerce\CheckoutFlow\CheckoutFlowInterface;
use Drupal\Core\Entity\EntityTypeManagerInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;


/**
 * Provides a checkout pane for ticket holder details (per ticket).
 *
 * @CommerceCheckoutPane(
 *   id = "ticket_holder_info",
 *   label = @Translation("Ticket holder details"),
 *   default_step = "order_information",
 *   wrapper_element = "fieldset",
 * )
 */
class TicketHolderPane extends CheckoutPaneBase implements ContainerFactoryPluginInterface {

  /**
   * Constructs a new TicketHolderPane object.
   */
  public function __construct(
    array $configuration,
    $plugin_id,
    $plugin_definition,
    CheckoutFlowInterface $checkout_flow,
    EntityTypeManagerInterface $entity_type_manager
  ) {
    parent::__construct($configuration, $plugin_id, $plugin_definition, $checkout_flow, $entity_type_manager);
    $this->entityTypeManager = $entity_type_manager;
  }

  /**
   * {@inheritdoc}
   */
  public static function create(
    ContainerInterface $container,
    array $configuration,
    $plugin_id,
    $plugin_definition,
    ?CheckoutFlowInterface $checkout_flow = null
  ) {
    return new static(
      $configuration,
      $plugin_id,
      $plugin_definition,
      $checkout_flow,
      $container->get('entity_type.manager')
    );
  }

  /**
   * {@inheritdoc}
   */
  public function buildPaneForm(array $pane_form, FormStateInterface $form_state, array &$complete_form) {
    /** @var \Drupal\commerce_order\Entity\OrderInterface $order */
    $order = $this->order;

    $pane_form['ticket_holder_info'] = [
      '#type' => 'details',
      '#title' => $this->t('Enter Your Details'),
      '#open' => TRUE,
    ];

    // Group line items by referenced event node.
    $grouped = [];

    foreach ($order->getItems() as $index => $line_item) {
      if ($line_item->bundle() !== 'ticket') {
        continue;
      }

      /** @var \Drupal\node\NodeInterface|null $event */
      if ($line_item->hasField('field_event_target') && !$line_item->get('field_event_target')->isEmpty()) {
        $event = $line_item->get('field_event_target')->entity;
      } else {
        $event = NULL;
      }

      $event_id = $event->id();
      $ticket_title = $line_item->getTitle();
      $quantity = (int) $line_item->getQuantity();


     if (!$event) {
        $event_label = $this->t('Unknown Event');
        $event_id = 'unknown_' . $index;
      } else {
        $event_label = $event->label();
        $event_id = $event->id();
      }


      $grouped[$event_id]['event'] = $event;
      $grouped[$event_id]['event_label'] = $event_label;
      $grouped[$event_id]['tickets'][] = [
        'line_item_index' => $index,
        'ticket_title' => $ticket_title,
        'quantity' => $quantity,
      ];
    }



    // Render form groups.
    foreach ($grouped as $event_id => $event_group) {
      $event = $event_group['event'];
      $event_fieldset_key = 'event_' . $event_id;

      $pane_form['ticket_holder_info'][$event_fieldset_key] = [
        '#type' => 'fieldset',
        '#title' => $this->t('Ticket Holders for: @event', ['@event' => $event_group['event_label']]),
        '#attributes' => ['class' => ['mel-ticket-group']],
      ];

      foreach ($event_group['tickets'] as $ticket) {
        $ticket_type_key = 'ticket_' . $ticket['line_item_index'];
        $pane_form['ticket_holder_info'][$event_fieldset_key][$ticket_type_key] = [
          '#type' => 'fieldset',
          '#title' => $this->t('Ticket Type: @type', ['@type' => $ticket['ticket_title']]),
          '#attributes' => ['class' => ['mel-ticket-type']],
        ];

        for ($i = 1; $i <= $ticket['quantity']; $i++) {
          $form_id = 'holder_' . $ticket['line_item_index'] . '_' . $i;
          $pane_form['ticket_holder_info'][$event_fieldset_key][$ticket_type_key][$form_id] = [
            '#type' => 'fieldset',
            '#title' => $this->t('Ticket @num', ['@num' => $i]),
            '#attributes' => ['class' => ['mel-ticket-holder']],
            'first_name' => [
              '#type' => 'textfield',
              '#title' => $this->t('First Name'),
              '#required' => TRUE,
            ],
            'last_name' => [
              '#type' => 'textfield',
              '#title' => $this->t('Last Name'),
              '#required' => TRUE,
            ],
            'email' => [
              '#type' => 'email',
              '#title' => $this->t('Email Address'),
              '#required' => TRUE,
            ],
          ];
        }
      }
    }

    return $pane_form;
  }

  /**
   * {@inheritdoc}
   */
  public function validatePaneForm(array &$pane_form, FormStateInterface $form_state, array &$complete_form): void {
    // Example: Email validation (optional)
    $values = $form_state->getValue('ticket_holder_info') ?? [];
    foreach ($values as $key => $ticket) {
      if (!empty($ticket['email']) && !filter_var($ticket['email'], FILTER_VALIDATE_EMAIL)) {
        $form_state->setErrorByName("ticket_holder_info][$key][email", $this->t('Enter a valid email.'));
      }
    }
  }

  /**
   * {@inheritdoc}
   */
  public function submitPaneForm(array &$pane_form, FormStateInterface $form_state, array &$complete_form): void {
    $values = $form_state->getValue('ticket_holder_info') ?? [];

    // ðŸ”’ Privacy-first best practice:
    // 1. Store securely (e.g., in a custom entity or private field on the Order).
    // 2. Do not expose in email or logs.
    // 3. Ensure export/report access is permission-guarded.

    \Drupal::logger('ticket_holder_info')->info('Storing ticket holder info for Order @order_id', [
      '@order_id' => $this->order->id(),
    ]);

    // @todo: Store in secure custom table or encrypted field.
  }

}