<?php

declare(strict_types=1);

use Drupal\Core\Template\Attribute;

/**
 * Implements hook_cron().
 */
function myeventlane_messaging_cron(): void {
  \Drupal::service('myeventlane_messaging.scheduler.boost')->scan();
  \Drupal::service('myeventlane_messaging.scheduler.cart')->scan();
  \Drupal::service('myeventlane_messaging.scheduler.event')->scan();
}

/**
 * Implements hook_theme().
 * (Drupal 11-safe: avoid drupal_get_path(); use extension.list.module service.)
 */
function myeventlane_messaging_theme($existing, $type, $theme, $path) {
  $tpl_path = \Drupal::service('extension.list.module')->getPath('myeventlane_messaging') . '/templates';
  return [
    'myeventlane_email' => [
      'variables' => ['body' => '', 'context' => []],
      'template'  => 'myeventlane-email',
      'path'      => $tpl_path,
    ],
    'myeventlane_messaging_inline' => [
      'variables' => ['template' => '', 'context' => []],
      'template'  => 'myeventlane-messaging-inline',
      'path'      => $tpl_path,
    ],
  ];
}

/**
 * Preprocess for myeventlane_email.
 */
function template_preprocess_myeventlane_email(array &$variables): void {
  $variables['#attributes']['style'] = 'margin:0;padding:0;background:#fef5ec;';
}

/**
 * Implements hook_mail().
 * Single generic key used by MessagingManager.
 */
function myeventlane_messaging_mail($key, &$message, $params) {
  if ($key !== 'generic') {
    return;
  }
  $message['subject'] = $params['subject'] ?? '(no subject)';
  $message['body']    = $params['html'] ?? $params['body'] ?? '';
  $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
}
