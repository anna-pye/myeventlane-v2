{#
/**
 * @file
 * Template for per-event analytics.
 *
 * Available variables:
 * - event: The event node.
 * - time_series: Time-series sales data.
 * - ticket_breakdown: Revenue breakdown by ticket type.
 * - sales_velocity: Sales velocity metrics.
 * - conversion_funnel: Conversion funnel data.
 * - bottlenecks: Conversion bottlenecks.
 * - total_revenue: Total revenue.
 * - total_tickets: Total tickets sold.
 */
#}
<div class="mel-analytics-event">

  <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
      <a href="{{ path('myeventlane_analytics.dashboard') }}" style="color: #007bff; text-decoration: none;">← {{ 'Back to Analytics Dashboard'|t }}</a>
      <h1 class="mel-analytics-title" style="margin-top: 1rem;">{{ 'Analytics: @event'|t({'@event': event.label}) }}</h1>
    </div>
    <div style="display: flex; gap: 0.75rem;">
      <a href="{{ path('myeventlane_analytics.export_pdf', {'node': event.id()}) }}" 
         class="mel-btn mel-btn-secondary" 
         target="_blank">
        {{ 'Export PDF'|t }}
      </a>
      <a href="{{ path('myeventlane_analytics.export_excel', {'node': event.id()}) }}" 
         class="mel-btn mel-btn-secondary">
        {{ 'Export Excel'|t }}
      </a>
    </div>
  </div>

  {# Summary Cards #}
  <div class="mel-analytics-summary" style="
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  ">
    <div class="mel-analytics-card" style="
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    ">
      <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #666; font-weight: 600;">{{ 'Total Revenue'|t }}</h3>
      <p style="margin: 0; font-size: 2rem; font-weight: 700; color: #28a745;">${{ total_revenue|number_format(2) }}</p>
    </div>

    <div class="mel-analytics-card" style="
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    ">
      <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #666; font-weight: 600;">{{ 'Tickets Sold'|t }}</h3>
      <p style="margin: 0; font-size: 2rem; font-weight: 700; color: #333;">{{ total_tickets }}</p>
    </div>

    <div class="mel-analytics-card" style="
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    ">
      <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #666; font-weight: 600;">{{ 'Average per Day'|t }}</h3>
      <p style="margin: 0; font-size: 2rem; font-weight: 700; color: #333;">{{ sales_velocity.average_per_day }}</p>
    </div>

    <div class="mel-analytics-card" style="
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    ">
      <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #666; font-weight: 600;">{{ 'Sales Trend'|t }}</h3>
      <p style="margin: 0; font-size: 1.25rem; font-weight: 700; color: {% if sales_velocity.trend == 'increasing' %}#28a745{% elseif sales_velocity.trend == 'decreasing' %}#dc3545{% else %}#666{% endif %};">
        {% if sales_velocity.trend == 'increasing' %}
          ↗ {{ 'Increasing'|t }}
        {% elseif sales_velocity.trend == 'decreasing' %}
          ↘ {{ 'Decreasing'|t }}
        {% else %}
          → {{ 'Stable'|t }}
        {% endif %}
      </p>
    </div>
  </div>

  {# Time Series Chart #}
  {% if time_series is not empty %}
    <section class="mel-analytics-section" style="
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    ">
      <h2 class="mel-section-title">{{ 'Sales Over Time'|t }}</h2>
      <div style="position: relative; height: 400px;">
        <canvas id="analytics-time-series-chart"></canvas>
      </div>
    </section>
  {% endif %}

  {# Conversion Funnel #}
  {% if conversion_funnel %}
    <section class="mel-analytics-section" style="
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    ">
      <h2 class="mel-section-title">{{ 'Conversion Funnel'|t }}</h2>
      
      {# Chart visualization #}
      <div style="position: relative; height: 300px; margin-bottom: 2rem;">
        <canvas id="analytics-conversion-funnel-chart"></canvas>
      </div>
      
      <div class="mel-funnel" style="display: flex; flex-direction: column; gap: 1rem;">
        {% set stages = [
          {'key': 'views', 'label': 'Event Views', 'count': conversion_funnel.views},
          {'key': 'cart_additions', 'label': 'Added to Cart', 'count': conversion_funnel.cart_additions},
          {'key': 'checkout_started', 'label': 'Checkout Started', 'count': conversion_funnel.checkout_started},
          {'key': 'completed', 'label': 'Completed', 'count': conversion_funnel.completed},
        ] %}
        
        {% for stage in stages %}
          <div class="mel-funnel-stage" style="
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <span style="font-weight: 600;">{{ stage.label }}</span>
            <span style="font-size: 1.25rem; font-weight: 700;">{{ stage.count }}</span>
          </div>
        {% endfor %}
      </div>

      {% if conversion_funnel.conversion_rates %}
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
          <h3 style="font-size: 1rem; margin-bottom: 1rem;">{{ 'Conversion Rates'|t }}</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
              <span style="font-size: 0.875rem; color: #666;">{{ 'Views to Cart'|t }}</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 700;">{{ conversion_funnel.conversion_rates.views_to_cart }}%</p>
            </div>
            <div>
              <span style="font-size: 0.875rem; color: #666;">{{ 'Cart to Checkout'|t }}</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 700;">{{ conversion_funnel.conversion_rates.cart_to_checkout }}%</p>
            </div>
            <div>
              <span style="font-size: 0.875rem; color: #666;">{{ 'Checkout to Complete'|t }}</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 700;">{{ conversion_funnel.conversion_rates.checkout_to_complete }}%</p>
            </div>
            <div>
              <span style="font-size: 0.875rem; color: #666;">{{ 'Overall Conversion'|t }}</span>
              <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 700;">{{ conversion_funnel.conversion_rates.overall }}%</p>
            </div>
          </div>
        </div>
      {% endif %}
    </section>
  {% endif %}

  {# Ticket Breakdown #}
  {% if ticket_breakdown is not empty %}
    <section class="mel-analytics-section" style="
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    ">
      <h2 class="mel-section-title">{{ 'Ticket Type Breakdown'|t }}</h2>
      
      {# Chart visualization #}
      <div style="position: relative; height: 300px; margin-bottom: 2rem;">
        <canvas id="analytics-ticket-breakdown-chart"></canvas>
      </div>
      
      <table class="mel-table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f5f5f5;">
            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">{{ 'Ticket Type'|t }}</th>
            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #ddd;">{{ 'Sold'|t }}</th>
            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #ddd;">{{ 'Revenue'|t }}</th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in ticket_breakdown %}
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 1rem; font-weight: 600;">{{ ticket.ticket_type }}</td>
              <td style="padding: 1rem; text-align: right;">{{ ticket.sold }}</td>
              <td style="padding: 1rem; text-align: right; font-weight: 600; color: #28a745;">${{ ticket.revenue|number_format(2) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% endif %}

  {# Bottlenecks #}
  {% if bottlenecks is not empty %}
    <section class="mel-analytics-section" style="
      background: #fff3cd;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      border-left: 4px solid #ffc107;
    ">
      <h2 class="mel-section-title">{{ 'Conversion Bottlenecks'|t }}</h2>
      
      {% for bottleneck in bottlenecks %}
        <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 4px;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600;">{{ bottleneck.label }}</h3>
          <p style="margin: 0 0 0.5rem 0; color: #666;">
            <strong>{{ 'Drop-off rate:'|t }}</strong> {{ bottleneck.drop_off_rate }}%
          </p>
          <p style="margin: 0; color: #333;">{{ bottleneck.recommendation }}</p>
        </div>
      {% endfor %}
    </section>
  {% endif %}

</div>






