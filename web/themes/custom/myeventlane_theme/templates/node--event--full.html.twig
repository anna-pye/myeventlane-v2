{#
/**
 * @file
 * Theme override to display an Event node in full view mode.
 *
 * Available variables:
 * - node: The node entity.
 * - label: The title of the node.
 * - content: All node items (fields).
 * - url: Direct URL of the current node.
 * - event_type: Event type ('rsvp', 'paid', 'both', 'external', 'none').
 * - event_type_label: Human-readable label ('RSVP', 'Tickets', etc.).
 * - event_cta_label: CTA button label.
 * - event_is_free: TRUE if event is RSVP only (free).
 * - event_is_bookable: TRUE if event can be booked.
 * - event_is_rsvp: TRUE if event supports RSVP.
 * - event_is_paid: TRUE if event has paid tickets.
 *
 * @see template_preprocess_node()
 */
#}

{{ attach_library('myeventlane_theme/global-styling') }}

{# Check if event is featured (boosted and not expired) #}
{% set is_featured = false %}
{% if node.field_promoted.value == 1 and node.field_promo_expires.value is not empty %}
  {% set expires_ts = node.field_promo_expires.value|date('U') %}
  {% set now_ts = 'now'|date('U') %}
  {% if expires_ts > now_ts %}
    {% set is_featured = true %}
  {% endif %}
{% endif %}

<article{{ attributes.addClass('mel-event-full') }}>

  {{ title_prefix }}
  {{ title_suffix }}

  {# Hero Section with Image #}
  <div class="mel-event-hero">
    {% if node.field_event_image.entity %}
      <div class="mel-event-hero-image" style="position: relative;">
        {# Badges Container #}
        <div class="mel-event-hero-badges" style="
          position: absolute;
          top: 1rem;
          right: 1rem;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          align-items: flex-end;
          z-index: 10;
        ">
          {# Featured Badge #}
          {% if is_featured %}
            {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
              type: 'featured',
              label: 'Featured',
              size: 'md',
            } only %}
          {% endif %}

          {# Event Type Badge #}
          {% if event_type is defined and event_type != 'none' %}
            {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
              type: event_type,
              label: event_type_label|default(''),
              size: 'md',
            } only %}
          {% endif %}
        </div>
        <img 
          src="{{ file_url(node.field_event_image.entity.uri.value) }}"
          alt="{{ node.field_event_image.alt }}"
          loading="eager"
        >
      </div>
    {% else %}
      <div class="mel-event-hero-image mel-event-hero-image--placeholder" style="position: relative;">
        {# Badges Container #}
        <div class="mel-event-hero-badges" style="
          position: absolute;
          top: 1rem;
          right: 1rem;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          align-items: flex-end;
          z-index: 10;
        ">
          {# Featured Badge #}
          {% if is_featured %}
            {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
              type: 'featured',
              label: 'Featured',
              size: 'md',
            } only %}
          {% endif %}

          {# Event Type Badge #}
          {% if event_type is defined and event_type != 'none' %}
            {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
              type: event_type,
              label: event_type_label|default(''),
              size: 'md',
            } only %}
          {% endif %}
        </div>
        <span class="mel-event-hero-icon">üìÖ</span>
      </div>
    {% endif %}

    <div class="mel-event-hero-overlay"></div>
  </div>

  {# Main Content #}
  <div class="mel-container">
    <div class="mel-event-layout">

      {# Left Column: Main Info #}
      <div class="mel-event-main">

        {# Date Badge #}
        {% if node.field_event_start[0] is defined and node.field_event_start[0].value is not empty %}
          {% set start_ts = node.field_event_start[0].value|date('U') %}
          <div class="mel-event-date-badge">
            <span class="mel-event-date-day">{{ start_ts|date('d') }}</span>
            <span class="mel-event-date-month">{{ start_ts|date('M') }}</span>
            <span class="mel-event-date-year">{{ start_ts|date('Y') }}</span>
          </div>
        {% endif %}

        {# Title #}
        <h1 class="mel-event-title">{{ label }}</h1>

        {# Category Tags #}
        {% if node.field_category is defined and node.field_category|length %}
          <div class="mel-event-categories">
            {% for term in node.field_category %}
              <a href="/events?category={{ term.entity.id }}" class="mel-chip mel-chip--sm">
                {{ term.entity.label }}
              </a>
            {% endfor %}
          </div>
        {% endif %}

        {# Meta Row: Date/Time and Location #}
        <div class="mel-event-meta">
          {# Date & Time #}
          {% if node.field_event_start[0] is defined %}
            {% set start_ts = node.field_event_start[0].value|date('U') %}
            <div class="mel-event-meta-item">
              <span class="mel-event-meta-icon">üìÖ</span>
              <div class="mel-event-meta-content">
                <strong>{{ start_ts|date('l, F j, Y') }}</strong>
                <span class="mel-event-meta-secondary">
                  {{ start_ts|date('g:i A') }}
                  {% if node.field_event_end[0] is defined and node.field_event_end[0].value is not empty %}
                    {% set end_ts = node.field_event_end[0].value|date('U') %}
                    ‚Äì {{ end_ts|date('g:i A') }}
                  {% endif %}
                </span>
              </div>
            </div>
          {% endif %}

          {# Location (show from field_location or legacy field_event_address) #}
          {% set loc_item = node.field_location[0] is defined and node.field_location[0] is not empty
            ? node.field_location[0]
            : (node.field_event_address[0] is defined and node.field_event_address[0] is not empty
              ? node.field_event_address[0]
              : null) %}
          {% if loc_item or node.field_venue_name.value is not empty %}
            <div class="mel-event-meta-item">
              <span class="mel-event-meta-icon">üìç</span>
              <div class="mel-event-meta-content">
                {% if node.field_venue_name.value is not empty %}
                  <strong>{{ node.field_venue_name.value }}</strong>
                  {% if loc_item %}
                    <span class="mel-event-meta-secondary">
                      {{ loc_item.address_line1 }}, {{ loc_item.locality }}{% if loc_item.administrative_area %}, {{ loc_item.administrative_area }}{% endif %}
                    </span>
                  {% endif %}
                {% elseif loc_item %}
                  <strong>{{ loc_item.address_line1 }}</strong>
                  <span class="mel-event-meta-secondary">
                    {{ loc_item.locality }}{% if loc_item.administrative_area %}, {{ loc_item.administrative_area }}{% endif %} {{ loc_item.postal_code }}
                  </span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>

        {# Description #}
        {% if content.body %}
          <div class="mel-event-description">
            <h2 class="mel-event-section-title">About this event</h2>
            {{ content.body }}
          </div>
        {% endif %}

        {# Additional Fields (if any) #}
        {% if content.field_event_details %}
          <div class="mel-event-details">
            {{ content.field_event_details }}
          </div>
        {% endif %}

        {# Accessibility Information Section #}
        {% if node.field_accessibility and not node.field_accessibility.isEmpty() or 
              node.field_accessibility_contact.value or 
              node.field_accessibility_directions.value or 
              node.field_accessibility_entry.value or 
              node.field_accessibility_parking.value %}
          <div class="mel-event-accessibility-section" style="
            margin-top: 3rem;
            padding: 2rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
          ">
            <h2 class="mel-event-section-title" style="
              margin-top: 0;
              margin-bottom: 1.5rem;
              font-size: 1.5rem;
              color: #2e7d32;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            ">
              <span aria-hidden="true">‚ôø</span>
              <span>{{ 'Accessibility Information'|t }}</span>
            </h2>

            {# Accessibility Features #}
            {% if node.field_accessibility and not node.field_accessibility.isEmpty() %}
              <div class="mel-event-accessibility-features" style="margin-bottom: 1.5rem;">
                <h3 style="
                  font-size: 1rem;
                  font-weight: 600;
                  margin-bottom: 0.75rem;
                  color: #333;
                ">{{ 'Accessibility Features'|t }}</h3>
                {% include '@myeventlane_theme/components/accessibility-icons.html.twig' with {
                  accessibility_terms: node.field_accessibility,
                  variant: 'badges',
                  max_display: 0,
                  show_all: true,
                } only %}
              </div>
            {% endif %}

            {# Structured Accessibility Information #}
            <div class="mel-event-accessibility-details" style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 1.5rem;
            ">
              {% if node.field_accessibility_contact.value %}
                <div class="mel-accessibility-detail-item">
                  <h4 style="
                    font-size: 0.875rem;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                    color: #666;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                  ">{{ 'Contact for Accessibility Inquiries'|t }}</h4>
                  <p style="margin: 0; color: #333; line-height: 1.6;">
                    {{ node.field_accessibility_contact.value }}
                  </p>
                </div>
              {% endif %}

              {% if node.field_accessibility_directions.value %}
                <div class="mel-accessibility-detail-item">
                  <h4 style="
                    font-size: 0.875rem;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                    color: #666;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                  ">{{ 'Travel Directions'|t }}</h4>
                  <p style="margin: 0; color: #333; line-height: 1.6;">
                    {{ node.field_accessibility_directions.value }}
                  </p>
                </div>
              {% endif %}

              {% if node.field_accessibility_entry.value %}
                <div class="mel-accessibility-detail-item">
                  <h4 style="
                    font-size: 0.875rem;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                    color: #666;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                  ">{{ 'Entry Information'|t }}</h4>
                  <p style="margin: 0; color: #333; line-height: 1.6;">
                    {{ node.field_accessibility_entry.value }}
                  </p>
                </div>
              {% endif %}

              {% if node.field_accessibility_parking.value %}
                <div class="mel-accessibility-detail-item">
                  <h4 style="
                    font-size: 0.875rem;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                    color: #666;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                  ">{{ 'Parking Information'|t }}</h4>
                  <p style="margin: 0; color: #333; line-height: 1.6;">
                    {{ node.field_accessibility_parking.value }}
                  </p>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

      </div>

      {# Right Column: Actions Sidebar #}
      <aside class="mel-event-sidebar">
        <div class="mel-event-actions-card">

          {# Price / Event Type Badge #}
          {% if event_type is defined %}
            {% if event_type == 'rsvp' %}
              <div class="mel-event-price mel-event-price--free">
                <span class="mel-event-price-value">{{ 'RSVP'|t }}</span>
              </div>
            {% elseif event_type == 'paid' or event_type == 'both' %}
              {% if node.field_event_price is defined and node.field_event_price.value is not empty %}
                <div class="mel-event-price">
                  <span class="mel-event-price-label">From</span>
                  <span class="mel-event-price-value">${{ node.field_event_price.value|number_format(2) }}</span>
                </div>
              {% else %}
                <div class="mel-event-price">
                  <span class="mel-event-price-value">Tickets Available</span>
                </div>
              {% endif %}
            {% elseif event_type == 'external' %}
              <div class="mel-event-price">
                <span class="mel-event-price-value">External Booking</span>
              </div>
            {% else %}
              <div class="mel-event-price mel-event-price--free">
                <span class="mel-event-price-value">{{ 'RSVP'|t }}</span>
              </div>
            {% endif %}
          {% else %}
            {# Fallback: Check raw field #}
            {% set raw_type = node.field_event_type.value|default('rsvp') %}
            {% if raw_type == 'rsvp' %}
              <div class="mel-event-price mel-event-price--free">
                <span class="mel-event-price-value">{{ 'RSVP'|t }}</span>
              </div>
            {% elseif raw_type == 'paid' or raw_type == 'both' %}
              <div class="mel-event-price">
                <span class="mel-event-price-value">Tickets Available</span>
              </div>
            {% else %}
              <div class="mel-event-price mel-event-price--free">
                <span class="mel-event-price-value">{{ 'RSVP'|t }}</span>
              </div>
            {% endif %}
          {% endif %}

          {# CTA Buttons #}
          <div class="mel-event-cta-buttons">
            {# Prefer the unified Event CTAs provided by myeventlane_event. #}
            {% if content.event_ctas is defined and content.event_ctas %}
              {{ content.event_ctas }}
            {% elseif event_type is defined %}
              {# Use event type variables for CTA #}
              {% if event_type == 'rsvp' %}
                <a href="{{ path('myeventlane_commerce.event_book', {'node': node.id}) }}" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block">
                  RSVP Now
                </a>
              {% elseif event_type == 'paid' or event_type == 'both' %}
                <a href="{{ path('myeventlane_commerce.event_book', {'node': node.id}) }}" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block">
                  Buy Tickets
                </a>
              {% elseif event_type == 'external' %}
                {% if node.field_external_url.uri %}
                  <a href="{{ node.field_external_url.uri }}" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block" target="_blank" rel="noopener noreferrer">
                    Get Tickets
                  </a>
                {% endif %}
              {% else %}
                <a href="{{ url }}#register" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block">
                  Register
                </a>
              {% endif %}
            {% elseif event_rsvp_enabled or event_tickets_enabled %}
              {# Legacy fallback: Use preprocess variables to build CTA. #}
              {% if event_tickets_enabled %}
                <a href="{{ path('myeventlane_commerce.event_book', {'node': node.id}) }}" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block">
                  Buy Tickets
                </a>
              {% elseif event_rsvp_enabled %}
                <a href="{{ path('myeventlane_commerce.event_book', {'node': node.id}) }}" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block">
                  RSVP Now
                </a>
              {% endif %}
            {% else %}
              {# Final fallback: simple register button. #}
              <a href="{{ url }}#register" class="mel-btn mel-btn-primary mel-btn-lg mel-btn-block">
                Register
              </a>
            {% endif %}

            <button type="button" class="mel-btn mel-btn-ghost mel-btn-block mel-event-share-btn">
              <span>Share Event</span>
            </button>
          </div>

          {# Waitlist Position Display #}
          {% if waitlist_position is defined and waitlist_position.on_waitlist %}
            <div class="mel-event-waitlist-position">
              {{ include('@myeventlane_event_attendees/waitlist-position-block.html.twig', waitlist_position, with_context = false) }}
            </div>
          {% endif %}

          {# Organizer Info #}
          {% if node.uid.entity %}
            <div class="mel-event-organizer">
              <h3 class="mel-event-organizer-label">Organised by</h3>
              <div class="mel-event-organizer-info">
                <div class="mel-event-organizer-avatar">
                  {{ node.uid.entity.name.value|first|upper }}
                </div>
                <div class="mel-event-organizer-name">
                  {{ node.uid.entity.name.value }}
                </div>
              </div>
            </div>
          {% endif %}

          {# Capacity / Spots Left #}
          {% if node.field_capacity.value is not empty %}
            <div class="mel-event-capacity">
              <span class="mel-event-capacity-icon">üë•</span>
              <span class="mel-event-capacity-text">
                {{ node.field_capacity.value }} spots available
              </span>
            </div>
          {% endif %}

        </div>

        {# Map / Location - rendered by myeventlane_location module if available #}
        {% if content.event_location_map %}
          {{ content.event_location_map }}
        {% elseif content.event_location_info %}
          {{ content.event_location_info }}
        {% else %}
          {# Legacy fallback: show address/venue without map if no coordinates #}
          {% set loc_item = node.field_location[0] is defined and node.field_location[0] is not empty
            ? node.field_location[0]
            : (node.field_event_address[0] is defined and node.field_event_address[0] is not empty
              ? node.field_event_address[0]
              : null) %}
          {% if loc_item or node.field_venue_name.value is not empty %}
            <div class="mel-event-map-card">
              <h3 class="mel-event-section-title">Location</h3>
              {% if node.field_venue_name.value is not empty %}
                <div class="mel-event-venue-name">
                  <strong>{{ node.field_venue_name.value }}</strong>
                </div>
              {% endif %}
              {% if loc_item %}
                <address class="mel-event-address">
                  {{ loc_item.address_line1 }}<br>
                  {{ loc_item.locality }}{% if loc_item.administrative_area %}, {{ loc_item.administrative_area }}{% endif %} {{ loc_item.postal_code }}
                </address>
              {% endif %}
            </div>
          {% endif %}
        {% endif %}

      </aside>

    </div>
  </div>

</article>
