{#
/**
 * @file
 * Header component with logo and navigation.
 */
#}

<header class="mel-header">
  <div class="mel-header-inner mel-container">

    {# Logo #}
    <div class="mel-header-left">
      <a href="{{ path('<front>') }}" class="mel-logo">
        <span class="mel-logo-icon">
          {# Inline SVG for the icon #}
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect width="64" height="64" rx="12" fill="#ff6f61"/>
            <path d="M16 64 C16 64 16 44 24 36 C28 32 34 34 38 32 C44 29 42 22 38 18 C34 14 28 16 24 22 C20 28 20 36 20 36" fill="#faf7fb"/>
            <line x1="40" y1="14" x2="48" y2="6" stroke="#ffd46f" stroke-width="4" stroke-linecap="round"/>
            <line x1="46" y1="20" x2="56" y2="16" stroke="#ffd46f" stroke-width="4" stroke-linecap="round"/>
            <line x1="48" y1="28" x2="58" y2="28" stroke="#ffd46f" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="mel-logo-text">
          <span class="mel-logo-my">My</span>
          <span class="mel-logo-eventlane">EventLane</span>
        </span>
      </a>
    </div>

    {# Desktop Navigation #}
    <nav class="mel-nav-desktop" aria-label="Main navigation">
      <ul class="mel-nav-list">
        <li><a href="/events" class="mel-nav-link">Events</a></li>
        <li><a href="/categories" class="mel-nav-link">Categories</a></li>
        <li><a href="/calendar" class="mel-nav-link">Calendar</a></li>
        <li><a href="/vendors" class="mel-nav-link">Organisers</a></li>
      </ul>
    </nav>

    {# Header Actions #}
    <div class="mel-header-actions">
      {# Shopping Cart #}
      {% if page.header.cart_block %}
        <div class="mel-header-cart">
          {{ page.header.cart_block }}
        </div>
      {% endif %}

      {% if logged_in %}
        {# Account Dropdown #}
        <div class="mel-account-dropdown">
          <button type="button" class="mel-btn mel-btn-ghost mel-account-toggle" aria-label="{{ 'Account menu'|t }}" aria-expanded="false">
            <span class="mel-account-icon">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="10" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                <path d="M3 18c0-3.314 3.134-6 7-6s7 2.686 7 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="mel-account-text">{{ user.display_name }}</span>
            <svg class="mel-dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="mel-account-menu" aria-hidden="true">
            <a href="{{ path('myeventlane_dashboard.customer') }}" class="mel-account-menu-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <rect x="2" y="2" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                <path d="M2 6h12M6 2v12" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              {{ 'My Events'|t }}
            </a>
            <a href="{{ path('entity.user.canonical', {'user': user.id}) }}" class="mel-account-menu-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="8" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/>
                <path d="M3 14c0-2.5 2.5-4.5 5-4.5s5 2 5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              {{ 'My Account'|t }}
            </a>
            <a href="{{ path('myeventlane_dashboard.vendor') }}" class="mel-account-menu-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <rect x="2" y="2" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
                <path d="M5 8h6M8 5v6" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              {{ 'Vendor Dashboard'|t }}
            </a>
            <div class="mel-account-menu-divider"></div>
            <a href="{{ path('user.logout') }}" class="mel-account-menu-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M6 14H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3M10 12l4-4-4-4M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ 'Log out'|t }}
            </a>
          </div>
        </div>
      {% else %}
        <a href="/user/login" class="mel-btn mel-btn-ghost">Log in</a>
      {% endif %}
      <a href="/node/add/event" class="mel-btn mel-btn-primary">Create Event</a>
    </div>

    {# Mobile Toggle #}
    <button class="mel-nav-toggle" aria-label="Open menu" aria-expanded="false">
      <span class="mel-nav-toggle-box">
        <span class="mel-nav-toggle-line"></span>
        <span class="mel-nav-toggle-line"></span>
        <span class="mel-nav-toggle-line"></span>
      </span>
    </button>

  </div>

  {# Mobile Navigation Drawer #}
  <div class="mel-nav-mobile-wrapper" aria-hidden="true">
    <div class="mel-nav-mobile-header">
      <button class="mel-nav-mobile-close" aria-label="Close menu">Ã—</button>
    </div>
    <nav class="mel-nav-mobile" aria-label="Mobile navigation">
      <ul class="mel-nav-mobile-list">
        <li><a href="/events">Browse Events</a></li>
        <li><a href="/categories">Categories</a></li>
        <li><a href="/calendar">Calendar</a></li>
        <li><a href="/vendors">Organisers</a></li>
        <li class="mel-mobile-divider"></li>
        {% if page.header.cart_block %}
          <li class="mel-mobile-cart">
            {{ page.header.cart_block }}
          </li>
          <li class="mel-mobile-divider"></li>
        {% endif %}
        {% if logged_in %}
          <li><a href="{{ path('myeventlane_dashboard.customer') }}">My Events</a></li>
          <li><a href="{{ path('myeventlane_dashboard.vendor') }}">Vendor Dashboard</a></li>
          <li><a href="{{ path('entity.user.canonical', {'user': user.id}) }}">My Account</a></li>
          <li><a href="/user/logout">Log out</a></li>
        {% else %}
          <li><a href="/user/login">Log in</a></li>
          <li><a href="/user/register">Sign up</a></li>
        {% endif %}
        <li class="mel-mobile-divider"></li>
        <li><a href="/node/add/event" class="mel-btn-mobile-accent">Create Event</a></li>
      </ul>
    </nav>
  </div>
</header>

{# Mobile overlay #}
<div class="mel-nav-overlay"></div>

{# Inline JavaScript for menus - non-module, works immediately #}
<script>
(function() {
  'use strict';
  
  // ============================================================================
  // Account Dropdown
  // ============================================================================
  function initAccountDropdown() {
    var dropdowns = document.querySelectorAll('.mel-account-dropdown:not([data-initialized])');
    
    dropdowns.forEach(function(dropdown) {
      dropdown.setAttribute('data-initialized', 'true');
      var toggle = dropdown.querySelector('.mel-account-toggle');
      var menu = dropdown.querySelector('.mel-account-menu');
      
      if (!toggle || !menu) {
        return;
      }
      
      toggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var isOpen = dropdown.classList.contains('is-open');
        
        if (isOpen) {
          dropdown.classList.remove('is-open');
          toggle.setAttribute('aria-expanded', 'false');
          menu.setAttribute('aria-hidden', 'true');
        } else {
          // Close all others
          document.querySelectorAll('.mel-account-dropdown.is-open').forEach(function(other) {
            if (other !== dropdown) {
              other.classList.remove('is-open');
              var otherToggle = other.querySelector('.mel-account-toggle');
              var otherMenu = other.querySelector('.mel-account-menu');
              if (otherToggle) otherToggle.setAttribute('aria-expanded', 'false');
              if (otherMenu) otherMenu.setAttribute('aria-hidden', 'true');
            }
          });
          
          dropdown.classList.add('is-open');
          toggle.setAttribute('aria-expanded', 'true');
          menu.setAttribute('aria-hidden', 'false');
        }
      });
      
      // Close on outside click
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && dropdown.classList.contains('is-open')) {
          dropdown.classList.remove('is-open');
          toggle.setAttribute('aria-expanded', 'false');
          menu.setAttribute('aria-hidden', 'true');
        }
      }, true);
      
      // Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && dropdown.classList.contains('is-open')) {
          dropdown.classList.remove('is-open');
          toggle.setAttribute('aria-expanded', 'false');
          menu.setAttribute('aria-hidden', 'true');
          toggle.focus();
        }
      });
    });
  }
  
  // ============================================================================
  // Mobile Navigation
  // ============================================================================
  function initMobileNav() {
    var toggle = document.querySelector('.mel-nav-toggle');
    var mobileNav = document.querySelector('.mel-nav-mobile-wrapper');
    var closeBtn = document.querySelector('.mel-nav-mobile-close');
    
    if (!toggle || !mobileNav) {
      return;
    }
    
    // Skip if already initialized
    if (toggle.hasAttribute('data-nav-initialized')) {
      return;
    }
    toggle.setAttribute('data-nav-initialized', 'true');
    
    // Create overlay if it doesn't exist
    var overlay = document.querySelector('.mel-nav-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'mel-nav-overlay';
      overlay.setAttribute('aria-hidden', 'true');
      document.body.appendChild(overlay);
    }
    
    function openNav() {
      mobileNav.classList.add('is-open');
      toggle.classList.add('is-active');
      overlay.classList.add('is-visible');
      toggle.setAttribute('aria-expanded', 'true');
      mobileNav.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      
      var firstLink = mobileNav.querySelector('a');
      if (firstLink) {
        firstLink.focus();
      }
    }
    
    function closeNav() {
      mobileNav.classList.remove('is-open');
      toggle.classList.remove('is-active');
      overlay.classList.remove('is-visible');
      toggle.setAttribute('aria-expanded', 'false');
      mobileNav.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      toggle.focus();
    }
    
    toggle.addEventListener('click', function() {
      if (mobileNav.classList.contains('is-open')) {
        closeNav();
      } else {
        openNav();
      }
    });
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeNav);
    }
    
    overlay.addEventListener('click', closeNav);
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && mobileNav.classList.contains('is-open')) {
        closeNav();
      }
    });
    
    // Close on resize to desktop
    var mediaQuery = window.matchMedia('(min-width: 768px)');
    mediaQuery.addEventListener('change', function(e) {
      if (e.matches && mobileNav.classList.contains('is-open')) {
        closeNav();
      }
    });
  }
  
  // Initialize immediately and on DOM ready
  function init() {
    initAccountDropdown();
    initMobileNav();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      init();
      // Retry after short delay
      setTimeout(init, 100);
    });
  } else {
    init();
    setTimeout(init, 100);
  }
  
  // Also register as Drupal behavior if available
  if (typeof Drupal !== 'undefined' && Drupal.behaviors) {
    Drupal.behaviors.myeventlaneMenusInline = {
      attach: function(context) {
        initAccountDropdown();
        initMobileNav();
      }
    };
  }
})();
</script>
