{#
/**
 * @file
 * Event card component with colorful placeholder backgrounds.
 *
 * A reusable card component for event listings. Can be included directly
 * or used as a template for Views.
 *
 * Available variables:
 * - node: The event node entity.
 * - url: The event URL.
 * - label: The event title.
 * - variant: Card variant (default, compact, featured).
 * - event_type: Event type ('rsvp', 'paid', 'both', 'external', 'none').
 * - event_type_label: Human-readable label ('RSVP', 'Tickets', etc.).
 * - event_cta_short: Short CTA label for buttons.
 */
#}

{% set variant = variant|default('default') %}
{% set card_classes = ['mel-event-card'] %}
{% if variant == 'featured' %}
  {% set card_classes = card_classes|merge(['mel-event-card--featured']) %}
{% elseif variant == 'compact' %}
  {% set card_classes = card_classes|merge(['mel-event-card--compact']) %}
{% endif %}

{# Pastel background colors - rotate based on node ID for variety #}
{% set bg_colors = ['lavender', 'mint', 'peach', 'sky', 'rose', 'yellow', 'coral'] %}
{% set bg_index = node.id|default(loop.index|default(1)) % 7 %}
{% set bg_color = bg_colors[bg_index] %}

{# Category-based emoji illustrations #}
{% set category_icons = {
  'music': 'üé∏',
  'workshop': 'üé®',
  'community': 'üë•',
  'food': 'üçï',
  'sports': '‚öΩ',
  'tech': 'üíª',
  'arts': 'üé≠',
  'wellness': 'üßò',
  'education': 'üìö',
  'lgbtq': 'üè≥Ô∏è‚Äçüåà',
  'default': 'üìÖ'
} %}

{% set category_name = node.field_category[0].entity.label|default('default')|lower %}
{% set card_icon = category_icons[category_name]|default(category_icons['default']) %}

{# Determine event type from field_event_type if not passed #}
{% set actual_event_type = event_type|default(node.field_event_type.value|default('rsvp')) %}

{# Check if event is featured (boosted and not expired) #}
{% set is_featured = false %}
{% if node.field_promoted.value == 1 and node.field_promo_expires.value is not empty %}
  {% set expires_ts = node.field_promo_expires.value|date('U') %}
  {% set now_ts = 'now'|date('U') %}
  {% if expires_ts > now_ts %}
    {% set is_featured = true %}
  {% endif %}
{% endif %}

<article class="{{ card_classes|join(' ') }}">

  {# Image or Placeholder #}
  {% set image = node.field_event_image.entity %}
  {% if image %}
    <div class="mel-event-card-image" style="position: relative;">
      {# Date Badge (floating) #}
      {% if node.field_event_start[0] is defined and node.field_event_start[0].value is not empty %}
        {% set ts = node.field_event_start[0].value|date('U') %}
        <div class="mel-event-card-date-badge" style="pointer-events: none;">
          <span class="mel-event-card-date-month">{{ ts|date('M') }}</span>
          <span class="mel-event-card-date-day">{{ ts|date('d') }}</span>
        </div>
      {% endif %}

      {# Badges Container - Top Right (consistent order: Featured first, then type) #}
      <div class="mel-event-card-badges" style="
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
        z-index: 10;
        pointer-events: none;
      ">
        {% if is_featured %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'featured',
            label: 'Featured',
            size: 'sm',
          } only %}
        {% endif %}

        {% if actual_event_type == 'rsvp' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'rsvp',
            size: 'sm',
          } only %}
        {% elseif actual_event_type == 'paid' or actual_event_type == 'tickets' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'paid',
            size: 'sm',
          } only %}
        {% elseif actual_event_type and actual_event_type != 'none' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: actual_event_type,
            size: 'sm',
          } only %}
        {% endif %}
      </div>

      <img 
        src="{{ file_url(image.uri.value) }}"
        alt="{{ image.alt }}"
        loading="lazy"
      >
    </div>
  {% else %}
    <div class="mel-event-card-image mel-event-card-image--placeholder mel-event-card-image--{{ bg_color }}" style="position: relative;">
      {# Date Badge (floating) #}
      {% if node.field_event_start[0] is defined and node.field_event_start[0].value is not empty %}
        {% set ts = node.field_event_start[0].value|date('U') %}
        <div class="mel-event-card-date-badge" style="pointer-events: none;">
          <span class="mel-event-card-date-month">{{ ts|date('M') }}</span>
          <span class="mel-event-card-date-day">{{ ts|date('d') }}</span>
        </div>
      {% endif %}

      {# Badges Container - Top Right (consistent order: Featured first, then type) #}
      <div class="mel-event-card-badges" style="
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
        z-index: 10;
        pointer-events: none;
      ">
        {% if is_featured %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'featured',
            label: 'Featured',
            size: 'sm',
          } only %}
        {% endif %}

        {% if actual_event_type == 'rsvp' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'rsvp',
            size: 'sm',
          } only %}
        {% elseif actual_event_type == 'paid' or actual_event_type == 'tickets' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'paid',
            size: 'sm',
          } only %}
        {% elseif actual_event_type and actual_event_type != 'none' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: actual_event_type,
            size: 'sm',
          } only %}
        {% endif %}
      </div>

      <span class="mel-event-card-illustration">{{ card_icon }}</span>
    </div>
  {% endif %}

  <div class="mel-event-card-body">

    {# Title #}
    <h3 class="mel-event-card-title">
      <a href="{{ url }}">{{ label }}</a>
    </h3>

    {# Meta Info #}
    <div class="mel-event-card-meta">
      {# Date #}
      {% if node.field_event_start[0] is defined and node.field_event_start[0].value is not empty %}
        {% set ts = node.field_event_start[0].value|date('U') %}
        <div class="mel-event-card-meta-item">
          <span class="mel-event-card-meta-icon">üìÖ</span>
          <span>{{ ts|date('M d, Y') }}</span>
        </div>
      {% endif %}

      {# Location #}
      {% if node.field_venue_name.value is not empty %}
        <div class="mel-event-card-meta-item">
          <span class="mel-event-card-meta-icon">üìç</span>
          <span>{{ node.field_venue_name.value }}</span>
        </div>
      {% elseif node.field_location.value is not empty %}
        {% set loc = node.field_location.value %}
        <div class="mel-event-card-meta-item">
          <span class="mel-event-card-meta-icon">üìç</span>
          <span>{{ loc.locality|default(loc.address_line1) }}</span>
        </div>
      {% endif %}
    </div>

    {# Footer with Price and CTA #}
    <div class="mel-event-card-footer">
      {# Price / Type Label #}
      {% if actual_event_type == 'rsvp' %}
        <span class="mel-event-card-price mel-event-card-price--free">Free</span>
      {% elseif actual_event_type == 'paid' or actual_event_type == 'both' %}
        {% if node.field_event_price is defined and node.field_event_price.value is not empty %}
          <span class="mel-event-card-price">
            From <strong>${{ node.field_event_price.value|number_format(0) }}</strong>
          </span>
        {% else %}
          <span class="mel-event-card-price">Tickets</span>
        {% endif %}
      {% elseif actual_event_type == 'external' %}
        <span class="mel-event-card-price">External</span>
      {% else %}
        <span class="mel-event-card-price mel-event-card-price--free">Free</span>
      {% endif %}

      {# CTA Button #}
      <div class="mel-event-card-cta">
        {% if event_cta_short is defined %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">{{ event_cta_short }}</a>
        {% elseif actual_event_type == 'rsvp' %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">RSVP</a>
        {% elseif actual_event_type == 'paid' or actual_event_type == 'both' %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">Tickets</a>
        {% elseif actual_event_type == 'external' %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">Get Tickets</a>
        {% else %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">View</a>
        {% endif %}
      </div>
    </div>

  </div>

</article>
