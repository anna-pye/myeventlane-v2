{#
/**
 * @file
 * Theme override for event nodes in teaser view mode.
 *
 * Renders as a beautiful event card with:
 * - Event type pill (RSVP / Tickets / Featured)
 * - Date badge
 * - Category chip
 * - Location info
 * - Accessibility indicators
 *
 * Available variables:
 * - node: The node entity.
 * - label: The node title.
 * - url: URL to the node.
 * - event_type: Event type ('rsvp', 'paid', 'both', 'external', 'none').
 * - event_type_label: Human-readable label ('RSVP', 'Tickets', etc.).
 * - event_cta_label: CTA button label.
 * - event_cta_short: Short CTA label for buttons.
 * - event_is_free: TRUE if event is RSVP only (free).
 * - event_is_bookable: TRUE if event can be booked.
 * - event_is_rsvp: TRUE if event supports RSVP.
 * - event_is_paid: TRUE if event has paid tickets.
 * - variant: Card variant ('default', 'featured', 'compact').
 */
#}

{% set variant = variant|default('default') %}
{% set card_classes = ['mel-event-card'] %}
{% if variant == 'featured' %}
  {% set card_classes = card_classes|merge(['mel-event-card--featured']) %}
{% endif %}

{# Pastel background colors - rotate based on node ID #}
{% set bg_colors = ['lavender', 'mint', 'peach', 'sky', 'rose', 'yellow', 'coral'] %}
{% set bg_index = node.id|default(1) % 7 %}
{% set bg_color = bg_colors[bg_index] %}

{# Category info and colors #}
{% set category_entity = node.field_category.entity %}
{% set category_label = category_entity.label|default('') %}
{% set category_name_lower = category_label|lower %}

{# Category emoji #}
{% set category_icons = {
  'music': 'üé∏',
  'movie': 'üé¨',
  'workshop': 'üé®',
  'community': 'üë•',
  'food & drink': 'üçï',
  'food': 'üçï',
  'sports': '‚öΩ',
  'tech': 'üíª',
  'arts': 'üé≠',
  'lgbtqi+': 'üè≥Ô∏è‚Äçüåà',
  'default': 'üìÖ'
} %}
{% set card_icon = category_icons[category_name_lower]|default(category_icons['default']) %}

{# Category colors - matching hero chips #}
{% set category_colors = {
  'music': '#8d79f6',
  'movie': '#3b82f6',
  'workshop': '#ff6f61',
  'community': '#3b82f6',
  'food & drink': '#70d6c4',
  'food': '#70d6c4',
  'arts': '#8d79f6',
  'lgbtqi+': '#ff6f61',
  'default': '#8888a0'
} %}
{% set category_color = category_colors[category_name_lower]|default(category_colors['default']) %}

{# Check if event is featured (boosted and not expired) #}
{% set is_featured = false %}
{% if node.field_promoted.value == 1 and node.field_promo_expires.value is not empty %}
  {% set expires_ts = node.field_promo_expires.value|date('U') %}
  {% set now_ts = 'now'|date('U') %}
  {% if expires_ts > now_ts %}
    {% set is_featured = true %}
  {% endif %}
{% endif %}

<article{{ attributes.addClass(card_classes) }}>

  {# Image or Placeholder #}
  {% if node.field_event_image.entity %}
    <div class="mel-event-card-image" style="position: relative;">
      {# Badges Container - Top Right #}
      <div class="mel-event-card-badges" style="
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
        z-index: 10;
        pointer-events: none;
      ">
        {# Featured Badge #}
        {% if is_featured %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'featured',
            label: 'Featured',
            size: 'sm',
          } only %}
        {% endif %}

        {# Event Type Badge - RSVP / Tickets / etc. #}
        {% if event_type is defined and event_type != 'none' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: event_type,
            label: event_type_label|default(''),
            size: 'sm',
          } only %}
        {% endif %}
      </div>

      {# Date Badge - Top Left #}
      {% if node.field_event_start.value %}
        <div class="mel-event-card-date-badge" style="pointer-events: none;">
          <span class="mel-event-card-date-month">{{ node.field_event_start.value|date('M')|upper }}</span>
          <span class="mel-event-card-date-day">{{ node.field_event_start.value|date('d') }}</span>
        </div>
      {% endif %}

      <img src="{{ file_url(node.field_event_image.entity.uri.value) }}" 
           alt="{{ node.field_event_image.alt }}" 
           loading="lazy">
    </div>
  {% else %}
    <div class="mel-event-card-image mel-event-card-image--placeholder mel-event-card-image--{{ bg_color }}" style="position: relative;">
      {# Badges Container - Top Right #}
      <div class="mel-event-card-badges" style="
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
        z-index: 10;
        pointer-events: none;
      ">
        {# Featured Badge #}
        {% if is_featured %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: 'featured',
            label: 'Featured',
            size: 'sm',
          } only %}
        {% endif %}

        {# Event Type Badge - RSVP / Tickets / etc. #}
        {% if event_type is defined and event_type != 'none' %}
          {% include '@myeventlane_theme/components/event-type-pill.html.twig' with {
            type: event_type,
            label: event_type_label|default(''),
            size: 'sm',
          } only %}
        {% endif %}
      </div>

      {# Date Badge - Top Left #}
      {% if node.field_event_start.value %}
        <div class="mel-event-card-date-badge" style="pointer-events: none;">
          <span class="mel-event-card-date-month">{{ node.field_event_start.value|date('M')|upper }}</span>
          <span class="mel-event-card-date-day">{{ node.field_event_start.value|date('d') }}</span>
        </div>
      {% endif %}

      <span class="mel-event-card-illustration">{{ card_icon }}</span>
    </div>
  {% endif %}

  <div class="mel-event-card-body">

  {# Title #}
    <h3 class="mel-event-card-title">
      <a href="{{ url }}">{{ label|default(node.label) }}</a>
    </h3>

    {# Category Tag #}
    {% if category_label %}
      <div class="mel-event-card-tags" style="margin-bottom: 0.5rem;">
        <span class="mel-category-chip" style="
          background-color: {{ category_color }}20;
          color: {{ category_color }};
          border: 1px solid {{ category_color }}40;
          padding: 0.25rem 0.75rem;
          font-size: 0.75rem;
          font-weight: 600;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          gap: 0.25rem;
        ">
          <span>{{ card_icon }}</span>
          {{ category_label }}
        </span>
      </div>
    {% endif %}

    

    {# Meta #}
    <div class="mel-event-card-meta">
      {% if node.field_event_start.value %}
        <div class="mel-event-card-meta-item">
          <span class="mel-event-card-meta-icon">üìÖ</span>
          <span>{{ node.field_event_start.value|date('M d, Y') }}</span>
        </div>
      {% endif %}
      {% if node.field_venue_name.value %}
        <div class="mel-event-card-meta-item">
          <span class="mel-event-card-meta-icon">üìç</span>
          <span>{{ node.field_venue_name.value }}</span>
        </div>
      {% endif %}
    </div>

    {# Accessibility Indicators #}
    {% if node.field_accessibility and not node.field_accessibility.isEmpty() %}
      <div class="mel-event-card-accessibility" style="
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
      ">
        {% include '@myeventlane_theme/components/accessibility-icons.html.twig' with {
          accessibility_terms: node.field_accessibility,
          variant: 'badges',
          max_display: 3,
          show_all: false,
        } only %}
      </div>
    {% endif %}

    {# Footer #}
    <div class="mel-event-card-footer">
      {# Event Type Label with proper styling #}
      {% if event_type is defined %}
        {% if event_type == 'rsvp' %}
          <span class="mel-event-card-price mel-event-card-price--free">Free</span>
        {% elseif event_type == 'paid' or event_type == 'both' %}
          {% if node.field_event_price is defined and node.field_event_price.value is not empty %}
            <span class="mel-event-card-price">
              From <strong>${{ node.field_event_price.value|number_format(2) }}</strong>
            </span>
          {% else %}
            <span class="mel-event-card-price">Tickets</span>
          {% endif %}
        {% elseif event_type == 'external' %}
          <span class="mel-event-card-price">External</span>
        {% else %}
          <span class="mel-event-card-price mel-event-card-price--free">Free</span>
        {% endif %}
      {% else %}
        {# Fallback: Check field_event_type directly if preprocess didn't run #}
        {% set raw_type = node.field_event_type.value|default('rsvp') %}
        {% if raw_type == 'rsvp' %}
          <span class="mel-event-card-price mel-event-card-price--free">Free</span>
        {% elseif raw_type == 'paid' or raw_type == 'both' %}
          <span class="mel-event-card-price">Tickets</span>
        {% else %}
          <span class="mel-event-card-price mel-event-card-price--free">Free</span>
        {% endif %}
      {% endif %}

      {# CTA Button #}
      <div class="mel-event-card-cta">
        {% if event_cta_short is defined %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">{{ event_cta_short }}</a>
        {% elseif event_type is defined %}
          {% if event_type == 'rsvp' %}
            <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">RSVP</a>
          {% elseif event_type == 'paid' or event_type == 'both' %}
            <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">Tickets</a>
          {% else %}
            <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">View</a>
          {% endif %}
        {% else %}
          <a href="{{ url }}" class="mel-btn mel-btn-primary mel-btn-sm mel-btn-pill">View</a>
        {% endif %}
      </div>
    </div>
  </div>

</article>
