{#
/**
 * @file
 * Theme override for the checkout form.
 *
 * Available variables:
 * - form: The checkout form with all its panes and elements.
 */
#}

<div class="mel-checkout">

  <div class="mel-checkout-main">

    {# ---------------------------------------------------------------------- #}
    {#  Progress Steps                                                         #}
    {# ---------------------------------------------------------------------- #}
    {% if form['#steps'] is defined %}
      <nav class="mel-checkout-steps" aria-label="Checkout progress">
        {% for step_id, step in form['#steps'] %}
          <div class="mel-checkout-step
                      {{ step.status == 'current' ? 'is-active' : '' }}
                      {{ step.status == 'complete' ? 'is-complete' : '' }}">
            <span class="mel-checkout-step-number">
              {% if step.status != 'complete' %}
                {{ loop.index }}
              {% endif %}
            </span>
            <span class="mel-checkout-step-label">{{ step.label }}</span>
          </div>
        {% endfor %}
      </nav>
    {% endif %}

    {# ---------------------------------------------------------------------- #}
    {#  Global messages (standard Drupal system)                               #}
    {# ---------------------------------------------------------------------- #}
    {{ status_messages }}

    {# ---------------------------------------------------------------------- #}
    {#  Checkout Panes                                                         #}
    {# ---------------------------------------------------------------------- #}
    {% for key, pane in form if key matches '/^(?!#|actions$|sidebar$)/' %}
      {% if pane['#type'] is defined or pane['#markup'] is defined %}
        <section class="mel-checkout-pane {{ key == 'payment_information' ? 'mel-checkout-pane--payment' : '' }}">
          {% if pane['#title'] is defined %}
            <h2 class="mel-checkout-pane-title">{{ pane['#title'] }}</h2>
          {% endif %}

          <div class="mel-checkout-pane-content">
            {{ pane }}
          </div>
        </section>
      {% endif %}
    {% endfor %}

    {# ---------------------------------------------------------------------- #}
    {#  Actions                                                                #}
    {# ---------------------------------------------------------------------- #}
    <div class="mel-checkout-actions">
      {{ form.actions }}
    </div>

  </div>

  {# ------------------------------------------------------------------------ #}
  {#  Sidebar: Order Summary                                                  #}
  {# ------------------------------------------------------------------------ #}
  <aside class="mel-checkout-sidebar">
    <div class="mel-checkout-order-summary">
      <h2 class="mel-checkout-order-title">Order Summary</h2>

      {% if form.sidebar is defined %}
        {{ form.sidebar }}
      {% endif %}

      <p class="mel-checkout-security">Secure checkout</p>
    </div>
  </aside>

</div>

{# -------------------------------------------------------------------------- #}
{#  Stripe Loader & Debug Utility                                             #}
{# -------------------------------------------------------------------------- #}
<script>
(function() {
  'use strict';

  console.log('üîç Stripe Loader: Starting on checkout page');

  function checkAndInit() {
    // Stripe.js
    if (typeof window.Stripe === 'undefined') {
      console.log('‚è≥ Waiting for Stripe.js...');
      return false;
    }

    // Drupal
    if (typeof Drupal === 'undefined' || !Drupal.behaviors) {
      console.log('‚è≥ Waiting for Drupal behaviors...');
      return false;
    }

    // drupalSettings
    if (typeof drupalSettings === 'undefined') {
      console.log('‚è≥ Waiting for drupalSettings...');
      return false;
    }

    // Stripe settings
    const hasElement = drupalSettings.commerceStripePaymentElement &&
                       drupalSettings.commerceStripePaymentElement.publishableKey;

    const hasForm = drupalSettings.commerceStripe &&
                    drupalSettings.commerceStripe.publishableKey;

    if (!hasElement && !hasForm) {
      console.log('‚è≥ Waiting for Stripe settings...');
      return false;
    }

    initPaymentFields();
    return true;
  }

  function safeAttach(behaviorName) {
    const behavior = Drupal.behaviors[behaviorName];
    if (behavior && typeof behavior.attach === 'function') {
      console.log(`‚û°Ô∏è Attaching behavior: ${behaviorName}`);
      behavior.attach(document, drupalSettings);
      return true;
    }
    console.warn(`‚ö†Ô∏è Behavior missing: ${behaviorName}`);
    return false;
  }

  function initPaymentFields() {
    console.log('üîÑ Initializing payment fields‚Ä¶');

    setTimeout(function() {

      // --------------------------
      // Payment Element mode
      // --------------------------
      if (drupalSettings.commerceStripePaymentElement) {
        const id = drupalSettings.commerceStripePaymentElement.elementId;
        const container = document.getElementById(id);

        if (container) {
          safeAttach('commerceStripePaymentElement');
        } else {
          console.error('‚ùå Payment Element container missing:', id);
        }
      }

      // --------------------------
      // Card Element Form mode
      // --------------------------
      if (drupalSettings.commerceStripe) {
        safeAttach('commerceStripeForm');
      }

    }, 400);
  }

  // Poller
  let attempts = 0;
  const maxAttempts = 200;

  const interval = setInterval(function() {
    attempts++;
    if (checkAndInit()) {
      clearInterval(interval);
    }
    if (attempts >= maxAttempts) {
      clearInterval(interval);
      console.error('‚ùå Stripe initialization failed after max attempts');
    }
  }, 100);

  // Run once immediately
  checkAndInit();

})();
</script>