{#
/**
 * @file
 * Event node template for full view mode (canonical route).
 *
 * Humanitix-level completeness with:
 * - Hero image with gradient overlay
 * - State badge and meta chips
 * - Two-column layout with sticky sidebar
 * - Card-based sections
 * - Mobile-first with sticky bottom CTA
 */
#}
{{ attach_library('myeventlane_theme/myeventlane_event_full') }}
{% if mel_lat is defined and mel_lng is defined and mel_lat and mel_lng %}
  {{ attach_library('myeventlane_location/event_map') }}
{% endif %}

<article{{ attributes.addClass('mel-event', 'mel-event--full') }}>
  
  {# ==========================================================================
     HERO SECTION
     ========================================================================== #}
  {% if hero_image_url is defined and hero_image_url %}
    <section class="event-hero">
      <img
        src="{{ hero_image_url }}"
        alt="{{ node.label }}"
        class="event-hero__image"
      />

      <div class="event-hero__overlay">
        <h1 class="event-hero__title">{{ node.label }}</h1>

        {% if mel_event_state is defined and mel_event_state %}
          <span class="event-hero__status">
            {% if mel_event_state == 'scheduled' %}
              {{ 'Scheduled'|t }}
            {% elseif mel_event_state == 'live' %}
              {{ 'Live'|t }}
            {% elseif mel_event_state == 'sold_out' %}
              {{ 'Sold Out'|t }}
            {% elseif mel_event_state == 'cancelled' %}
              {{ 'Cancelled'|t }}
            {% elseif mel_event_state == 'ended' %}
              {{ 'Ended'|t }}
            {% else %}
              {{ 'Draft'|t }}
            {% endif %}
          </span>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {# ==========================================================================
     CANCELLED BANNER (if cancelled)
     ========================================================================== #}
  {% if mel_event_state is defined and mel_event_state == 'cancelled' %}
    <div class="mel-event-cancelled-banner">
      <p class="mel-event-cancelled-banner__text">
        <strong>{{ 'This event has been cancelled.'|t }}</strong>
        {% if node.hasField('body') and not node.body.isEmpty %}
          {{ 'Please check back for updates or contact the organiser.'|t }}
        {% endif %}
      </p>
    </div>
  {% endif %}

  {# ==========================================================================
     MAIN CONTENT GRID
     ========================================================================== #}
  <div class="mel-event-grid">
    
    {# Left Column: Main Content #}
    <div class="mel-event-grid__main">
      
      {# About Section Card #}
      {% if node.hasField('body') and not node.body.isEmpty and content.body %}
        <section class="mel-event-card mel-event-card--about">
          <h2 class="mel-event-card__title">{{ 'About this event'|t }}</h2>
          <div class="mel-event-card__content">
            {{ content.body }}
          </div>
        </section>
      {% endif %}

      {# Accessibility & Inclusion Section Card #}
      {% if node.hasField('field_accessibility') and not node.field_accessibility.isEmpty %}
        <section class="mel-event-card mel-event-card--accessibility">
          <h2 class="mel-event-card__title">{{ 'Accessibility & inclusion'|t }}</h2>
          <div class="mel-event-card__content">
            {% if content.field_accessibility %}
              {% include '@myeventlane_theme/components/accessibility-icons.html.twig' with {
                accessibility_terms: content.field_accessibility,
                variant: 'badges',
                show_all: true
              } only %}
            {% endif %}
            <p class="mel-helper">{{ 'Inclusive by design. If you need support, the organiser can help.'|t }}</p>
          </div>
        </section>
      {% endif %}

      {# Refund / Cancellation Policy Section Card #}
      {% if node.hasField('field_refund_policy') and not node.field_refund_policy.isEmpty %}
        <section class="mel-event-card mel-event-card--policy">
          <h2 class="mel-event-card__title">{{ 'Refund / cancellation policy'|t }}</h2>
          <div class="mel-event-card__content">
            <p>{{ node.field_refund_policy.value|replace({
              'none_specified': 'No specified policy on refunds',
              '1_day': 'Refunds are available up to 1 day prior to the event',
              '7_days': 'Refunds are available up to 7 days prior to the event',
              '14_days': 'Refunds are available up to 14 days prior to the event',
              '30_days': 'Refunds are available up to 30 days prior to the event',
              'no_refunds': 'No refunds'
            }) }}</p>
          </div>
        </section>
      {% endif %}

      {# Hosted by Section Card (linked) #}
      {% if event_host %}
        <section class="mel-event-card mel-event-card--host">
          <h2 class="mel-event-card__title">{{ 'Hosted by'|t }}</h2>
          <div class="mel-event-card__content">
            <div class="event-host">
              {{ 'Hosted by'|t }}
              <a href="{{ event_host.url }}">
                {{ event_host.name }}
              </a>
            </div>
          </div>
        </section>
      {% endif %}

      {# Tags / Keywords Section Card #}
      {% if node.hasField('field_tags') and not node.field_tags.isEmpty %}
        <section class="mel-event-card mel-event-card--tags">
          <h2 class="mel-event-card__title">{{ 'Tags / keywords'|t }}</h2>
          <div class="mel-event-card__content">
            <div class="mel-tags">
              {% for tag in node.field_tags %}
                {% if tag.entity %}
                  <span class="mel-tag">{{ tag.entity.label }}</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </section>
      {% endif %}

    </div>

    {# Right Column: Sticky Sidebar #}
    <aside class="mel-event-sidebar">
      
      {# Action Card (Sticky) #}
      <div class="mel-event-sidebar__action-card">
        {# Registration Badge #}
        {% if mel_registration_badge is defined and mel_registration_badge %}
          <div class="mel-event-sidebar__section mel-event-sidebar__section--badge">
            <div class="mel-event-sidebar__registration-badge">
              {{ mel_registration_badge }}
            </div>
          </div>
        {% endif %}

        {# Primary CTA - show if event_cta exists and has a label #}
        {% if event_cta and event_cta.label %}
          <div class="mel-event-sidebar__section mel-event-sidebar__section--cta">
            {% if event_cta.url %}
              <a href="{{ event_cta.url }}" class="mel-btn mel-btn--primary event-cta">
                {{ event_cta.label }}
              </a>
            {% else %}
              <span class="mel-btn mel-btn--disabled">
                {{ event_cta.label }}
              </span>
            {% endif %}
            
            {# Secondary CTA for "both" mode (RSVP when tickets are primary) #}
            {% if event_cta_secondary and event_cta_secondary.url and event_cta_secondary.label %}
              <a href="{{ event_cta_secondary.url }}" class="mel-btn mel-btn--secondary event-cta" style="margin-top: 0.75rem; display: block;">
                {{ event_cta_secondary.label }}
              </a>
            {% endif %}
          </div>
        {% endif %}

        {# Price Summary #}
        {% if mel_price_summary is defined and mel_price_summary %}
          <div class="mel-event-sidebar__section mel-event-sidebar__section--price">
            <div class="mel-event-sidebar__price">{{ mel_price_summary }}</div>
          </div>
        {% endif %}

        {# Date & Time #}
        {% if node.hasField('field_event_start') and not node.field_event_start.isEmpty %}
          <div class="mel-event-sidebar__section">
            <h3 class="mel-event-sidebar__title">{{ 'Date & time'|t }}</h3>
            <time datetime="{{ node.field_event_start.value|date('c') }}" class="mel-event-sidebar__date">
              <div class="mel-event-sidebar__date-main">
                {{ node.field_event_start.value|date('l j F Y') }}
              </div>
              <div class="mel-event-sidebar__date-time">
                {{ node.field_event_start.value|date('g:ia') }}
                {% if node.hasField('field_event_end') and not node.field_event_end.isEmpty and node.field_event_end.value %}
                  – {{ node.field_event_end.value|date('g:ia') }}
                {% endif %}
              </div>
            </time>

            {# Calendar buttons (pill group) #}
            {% if mel_ics_url is defined and mel_ics_url or mel_google_cal_url is defined and mel_google_cal_url %}
              <div class="mel-event-sidebar__calendar-links">
                {% if mel_ics_url is defined and mel_ics_url %}
                  <a href="{{ mel_ics_url }}" 
                     download="{{ node.label|replace({' ': '_'}) }}.ics"
                     class="mel-event-sidebar__calendar-link">
                    {{ 'Apple / Outlook (.ics)'|t }}
                  </a>
                {% endif %}
                {% if mel_google_cal_url is defined and mel_google_cal_url %}
                  <a href="{{ mel_google_cal_url }}" 
                     target="_blank" 
                     rel="noopener"
                     class="mel-event-sidebar__calendar-link">
                    {{ 'Google Calendar'|t }}
                  </a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endif %}

        {# Location + Map (embedded) #}
        {% if event_location %}
          <div class="mel-event-sidebar__section event-info__location">
            <h3 class="mel-event-sidebar__title">{{ 'Location'|t }}</h3>
            {% if event_location.venue_name %}
              <strong>{{ event_location.venue_name }}</strong>
            {% endif %}
            <div class="event-location__address">
              {{ event_location.address }}
            </div>
            <a href="{{ event_location.map_url }}"
               target="_blank"
               rel="noopener"
               class="event-location__map-link">
              {{ 'View on map'|t }} →
            </a>
          </div>
        {% endif %}


      </div>
    </aside>

  </div>

  {# ==========================================================================
     MOBILE STICKY CTA BAR
     ========================================================================== #}
  {% if event_cta and event_cta.url %}
    <div class="mel-event-cta-mobile-sticky">
      <a href="{{ event_cta.url }}"
         class="mel-btn mel-btn--primary event-cta">
        {{ event_cta.label }}
      </a>
    </div>
  {% endif %}

</article>
